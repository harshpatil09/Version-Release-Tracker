<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Version History</title>
    <link
      rel="stylesheet"
      href="{{url_for('static', filename = 'css/version_hist.css')}}"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <a href="{{url_for('home')}}" class="back-btn">‚¨Ö Back to Home</a>
    <h1 class="text-center my-3">Version History</h1>

    <div class="table-responsive" style="table-layout: fixed; max-height: 400px; overflow: auto;">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>Release ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Application</th>
            <th>Module</th>
            <th>Submodule</th>
            <th>ENV</th>
            <th>Technology</th>
            <th>Version Type</th>
            <th>Version</th>
            <th>Version Status</th>
            <th>Bug ID</th>
            <th>Ticket ID</th>
            <th>Release Date</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in data %}
          <tr>
            <td>{{item.ReleaseID}}</td>
            <td>{{item.Username}}</td>
            <td>{{item.Role}}</td>
            <td>{{item.Application}}</td>
            <td>{{item.Module}}</td>
            <td>{{item.Submodule}}</td>
            <td>{{item.ENV}}</td>
            <td>{{item.Technology}}</td>
            <td>{{item.VersionType}}</td>
            <td>{{item.Version}}</td>
            <td>{{item.VersionStatus}}</td>
            <td>{{item.BugID}}</td>
            <td>{{item.TicketID}}</td>
            <td>{{item.ReleaseDate}}</td>
            <td
              style="
                word-break: break-word; 
                max-width: 2000px;
              "
            >
              {{ item.Description }}
            </td>

            <td class="text-center">
              <div class="d-flex justify-content-center gap-2">
                <!-- Edit Button -->
                <button
                  type="button"
                  class="btn btn-sm btn-primary edit-btn"
                  data-id="{{item.ReleaseID}}"
                  data-version="{{item.Version}}"
                  data-status="{{item.VersionStatus}}"
                  data-bugid="{{item.BugID}}"
                  data-ticketid="{{item.TicketID}}"
                  data-date="{{item.ReleaseDate}}"
                  data-description="{{item.Description}}"
                >
                  ‚úèÔ∏è
                </button>

                <!-- Delete Button -->
                <a
                  href="{{ url_for('delete_version_record', ReleaseID=item.ReleaseID) }}"
                  class="btn btn-sm btn-danger"
                  onclick="return confirm('Are you sure you want to delete Release ID {{ item.ReleaseID }}?');"
                >
                  üóëÔ∏è
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-3 shadow">
          <div class="modal-header">
            <h5 class="modal-title">Edit Release</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" name="ReleaseID" id="ReleaseID" />

              <div class="mb-3">
                <label class="form-label">Version</label>
                <input
                  type="text"
                  class="form-control"
                  id="Version"
                  name="Version"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Version Status</label>
                <select
                  class="form-select"
                  id="VersionStatus"
                  name="VersionStatus"
                  required
                >
                  <option value="Released">Released</option>
                  <option value="In Progress">In Progress</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Roll Back">Roll Back</option>
                  <option value="Upcoming">Upcoming</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Bug ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="BugID"
                  name="BugID"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Ticket ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="TicketID"
                  name="TicketID"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Release Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="ReleaseDate"
                  name="ReleaseDate"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="Description"
                  name="Description"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-success" id="saveChanges">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const releaseDateInput = document.getElementById("ReleaseDate");

      // Set today's date as default
      const today = new Date().toISOString().split("T")[0];
      releaseDateInput.min = today;

      // Open modal and load data
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          document.getElementById("ReleaseID").value = this.dataset.id;
          document.getElementById("Version").value = this.dataset.version;
          document.getElementById("VersionStatus").value = this.dataset.status;
          document.getElementById("BugID").value = this.dataset.bugid;
          document.getElementById("TicketID").value = this.dataset.ticketid;
          document.getElementById("ReleaseDate").value = this.dataset.date;
          document.getElementById("Description").value =
            this.dataset.description;

          let modal = new bootstrap.Modal(document.getElementById("editModal"));
          modal.show();
        });
      });

      // Save changes -> Flask route
      document
        .getElementById("saveChanges")
        .addEventListener("click", function () {
          let formData = new FormData(document.getElementById("editForm"));
          fetch("{{ url_for('update_release') }}", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.text())
            .then((html) => {
              // close modal
              let modalEl = document.getElementById("editModal");
              let modal = bootstrap.Modal.getOrCreateInstance(modalEl);
              modal.hide();
              location.reload();
            });
        });
    </script>

    {% with messages = get_flashed_messages() %} {% if messages %}
    <script>
      alert("{{ messages[0] }}");
    </script>
    {% endif %} {% endwith %}
  </body>
</html>
